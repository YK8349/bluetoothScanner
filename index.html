<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Power Vision S1 Web Controller ‚Äî Fixed</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ÔºàÁúÅÁï•„Åõ„Åö„Åù„ÅÆ„Åæ„Åæ‰Ωø„Åà„Çã„Çà„ÅÜ„Å´ÂÖÉ„ÅÆ„Çπ„Çø„Ç§„É´„Çí‰øùÊåÅÔºâ */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f0f2f5; }
    .container { display: flex; flex-direction: column; gap: 20px; }
    .control-group { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h1, h2 { text-align: center; color: #333; }
    button { padding: 12px 18px; font-size: 16px; cursor: pointer; border-radius: 6px; border: 1px solid transparent; transition: all 0.2s ease; }
    button:disabled { cursor: not-allowed; opacity: 0.5; }
    #connection-status { font-weight: bold; padding: 5px 10px; border-radius: 5px; color: #fff; }
    #log-area { width: 100%; height: 150px; border: 1px solid #ccc; border-radius: 3px; padding: 5px; box-sizing: border-box; white-space: pre-wrap; overflow-y: scroll; background-color: #fafafa; }
    #connect-button { background-color: #007bff; color: white; border-color: #007bff; }
    #connect-button:hover:not(:disabled) { background-color: #0056b3; }
    #disconnect-button { background-color: #dc3545; color: white; border-color: #dc3545; }
    #disconnect-button:hover:not(:disabled) { background-color: #c82333; }
    .controls-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; justify-items: center; }
    .d-pad { grid-column: 1 / 2; display: grid; grid-template-areas: ". up ." "left center right" ". down ."; width: 150px; height: 150px; }
    .d-pad button { width: 50px; height: 50px; padding: 0; display: flex; justify-content: center; align-items: center; font-size: 24px; background-color: #5a6268; color: white; }
    .d-pad button:hover:not(:disabled) { background-color: #4a5056; }
    #up-button { grid-area: up; }
    #left-button { grid-area: left; }
    #right-button { grid-area: right; }
    #down-button { grid-area: down; }
    .action-buttons { grid-column: 2 / 3; display: flex; flex-direction: column; gap: 15px; justify-content: center; }
    .zoom-buttons { grid-column: 3 / 4; display: flex; flex-direction: column; gap: 15px; justify-content: center; }
    .action-buttons button, .zoom-buttons button { width: 150px; background-color: #28a745; color: white; }
    .action-buttons button:hover:not(:disabled), .zoom-buttons button:hover:not(:disabled) { background-color: #218838; }
    #power-button { background-color: #ffc107; color: #212529; }
    #power-button:hover:not(:disabled) { background-color: #e0a800; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Power Vision S1 Web Controller</h1>

    <div class="control-group">
      <h2><span style="font-size: 1.2em;">üì°</span> Connection</h2>
      <button id="connect-button">Connect to S1 Device</button>
      <button id="disconnect-button" disabled>Disconnect</button>
      <p>Status: <span id="connection-status" style="background-color: red;">DISCONNECTED</span></p>
    </div>

    <div class="control-group" id="main-controls" style="display: none;">
      <h2><span style="font-size: 1.2em;">üïπÔ∏è</span> Controls</h2>
      <div class="controls-grid">
        <div class="d-pad">
          <button id="up-button" data-command="ea550d0a135c2301000000d85e" data-hold-command="ea550d0a135c2303000000b0b3" data-repeatable="true">‚ñ≤</button>
          <button id="left-button" data-command="ea550d0a135c2310000000cb33" data-hold-command="ea550d0a135c23300000008504" data-repeatable="true">‚óÄ</button>
          <button id="center-button" data-command="ea550d0a135c23000010001f2b" data-hold-command="ea550d0a135c230000f000ad3b" data-repeatable="true" style="grid-area: center;">Push</button>
          <button id="right-button" data-command="ea550d0a135c2340000000f046" data-hold-command="ea550d0a135c23c0000000c89b" data-repeatable="true">‚ñ∂</button>
          <button id="down-button" data-command="ea550d0a135c23040000009de2" data-hold-command="ea550d0a135c230c0000005e67" data-repeatable="true">‚ñº</button>
        </div>

        <div class="action-buttons">
          <button id="record-button" data-command="ea550d0a135c23001000000f6b" data-hold-command="ea550d0a135c2300f000003ecb" data-release-command="ea550d0a135c2300e000005d88">Record</button>
          <button id="orientation-button" data-command="ea550d0a135c23000002000e4e">Toggle Orientation</button>
          <button id="reset-button" data-command="ea550d0a135c23000020008a2e,ea550d0a139c0c804c060162f4">Reset Position</button>
          <button id="power-button" data-command="ea550d0a135c23000001005d1b">Power</button>
        </div>

        <div class="zoom-buttons">
          <button id="zoom-in-button" data-command="ea550d0a135c2300040000acf4" data-hold-command="ea550d0a135c23000c00000d5d" data-release-command="ea550d0a135c2300080000cd81" data-repeatable="true">Zoom In (+)</button>
          <button id="zoom-out-button" data-command="ea550d0a135c23000100005c1f" data-hold-command="ea550d0a135c23000300003c71" data-release-command="ea550d0a135c23000200000c46" data-repeatable="true">Zoom Out (-)</button>
        </div>
      </div>
    </div>

    <div class="control-group">
      <h2><span style="font-size: 1.2em;">üìã</span> Log</h2>
      <textarea id="log-area" readonly></textarea>
      <button id="clear-log-button" style="margin-top: 10px;">Clear Log</button>
    </div>
  </div>

  <script>
    // Nordic UART UUIDs (‰∏ÄËà¨ÁöÑ„Å™ UART „Çµ„Éº„Éì„Çπ„Çí‰ªÆÂÆö)
    const NORDIC_UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const NORDIC_UART_RX_CHARACTERISTIC_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write (central -> peripheral)
    const NORDIC_UART_TX_CHARACTERISTIC_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify (peripheral -> central)

    // UI
    const connectButton = document.getElementById('connect-button');
    const disconnectButton = document.getElementById('disconnect-button');
    const statusSpan = document.getElementById('connection-status');
    const logArea = document.getElementById('log-area');
    const clearLogButton = document.getElementById('clear-log-button');
    const mainControls = document.getElementById('main-controls');

    let bluetoothDevice = null;
    let uartWriteChar = null; // Êõ∏„ÅçËæº„ÅøÁî®„Ç≠„É£„É©„ÇØ„Çø„É™„Çπ„ÉÜ„Ç£„ÉÉ„ÇØÔºàRX UUIDÔºâ
    let uartNotifyChar = null; // ÈÄöÁü•Âèó‰ø°Áî®„Ç≠„É£„É©

    // Èï∑Êäº„Åó / Áπ∞„ÇäËøî„ÅóÁî®
    let pressTimer = null;
    let repeatIntervalTimer = null;
    let isLongPress = false;
    let activeButton = null;
    const LONG_PRESS_DURATION = 250; // ms
    const REPEAT_INTERVAL = 150; // ms

    // ------------ Connection ------------
    connectButton.addEventListener('click', async () => {
      log('Requesting device...');
      try {
        // Âèó‰ø°„ÅØÂá∫Êù•„Å¶„ÅÑ„Çã„Å®„ÅÆ„Åì„Å®„Å™„ÅÆ„Åß„ÄÅ‰ª•‰∏ã„ÅØ optionalServices „Å´ UART „ÇíÂÖ•„Çå„Å¶Êé•Á∂ö„Åô„Çã‰æã„Åß„Åô„ÄÇ
        bluetoothDevice = await navigator.bluetooth.requestDevice({
          // Âèó‰ø°„ÅåÂá∫Êù•„Å¶„ÅÑ„Çã„Å™„Çâ filters„Åß„ÇÇOK„Åß„Åô„Åå„ÄÅ„Éá„Éê„Ç§„ÇπÂêç„ÅåÂ§â„Çè„ÇãÂ†¥Âêà„ÅÆ„Åü„ÇÅ acceptAllDevices„Åß„ÅÆÊé•Á∂ö„ÇÇÊ§úË®é„Åó„Å¶„Åè„Å†„Åï„ÅÑ:
          // acceptAllDevices: true,
          filters: [{ namePrefix: 'S1' }], // ÂøÖË¶Å„Å´Âøú„Åò„Å¶Â§âÊõ¥„ÄÇÂèó‰ø°Âá∫Êù•„Å¶„ÅÑ„Çã„ÅÆ„Åß„Åì„ÅÆ„Åæ„Åæ„Åß„ÇÇËâØ„ÅÑ„ÅØ„Åö„ÄÇ
          optionalServices: [NORDIC_UART_SERVICE_UUID]
        });

        bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
        log('Connecting to GATT server...');
        const server = await bluetoothDevice.gatt.connect();

        log('Getting UART service...');
        const service = await server.getPrimaryService(NORDIC_UART_SERVICE_UUID);

        log('Getting characteristics...');
        uartWriteChar = await service.getCharacteristic(NORDIC_UART_RX_CHARACTERISTIC_UUID);
        uartNotifyChar = await service.getCharacteristic(NORDIC_UART_TX_CHARACTERISTIC_UUID);

        log('Starting notifications...');
        await uartNotifyChar.startNotifications();
        uartNotifyChar.addEventListener('characteristicvaluechanged', handleNotifications);

        updateUIForConnection();
        log('Ready! Use the controls to operate the device.');

      } catch (err) {
        log(`Connection Error: ${err}`);
        console.error(err);
        if (bluetoothDevice && bluetoothDevice.gatt.connected) bluetoothDevice.gatt.disconnect();
      }
    });

    disconnectButton.addEventListener('click', () => {
      if (bluetoothDevice && bluetoothDevice.gatt.connected) {
        log('Disconnecting...');
        bluetoothDevice.gatt.disconnect();
      }
    });

    function onDisconnected() {
      log('Device disconnected.');
      updateUIForDisconnection();
      uartWriteChar = null;
      uartNotifyChar = null;
      bluetoothDevice = null;
    }

    function handleNotifications(event) {
      const value = event.target.value;
      let hex = '';
      for (let i = 0; i < value.byteLength; i++) {
        hex += value.getUint8(i).toString(16).padStart(2, '0');
      }
      log(`Received: ${hex}`);
    }

    // ------------ Send command helper ------------
    // 16ÈÄ≤ÊñáÂ≠óÂàó„ÇíÊ≠£Ë¶èÂåñ„Åó„Å¶ Uint8Array „ÇíËøî„ÅôÔºà„Ç®„É©„ÉºÊôÇ„ÅØ null „ÇíËøî„ÅôÔºâ
    function hexStringToUint8(hexStr) {
      if (!hexStr) return null;
      // remove spaces, 0x, etc.
      let s = String(hexStr).replace(/\s+/g, '').replace(/0x/gi, '').toLowerCase();
      // odd length? -> invalid
      if (s.length === 0) return null;
      if (s.length % 2 !== 0) {
        log(`Invalid hex string (odd length): ${hexStr}`);
        return null;
      }
      const bytes = s.match(/.{1,2}/g).map(b => parseInt(b, 16));
      if (bytes.some(isNaN)) {
        log(`Invalid hex characters in: ${hexStr}`);
        return null;
      }
      return new Uint8Array(bytes);
    }

    // ÂÆüÈöõ„ÅÆÈÄÅ‰ø°Âá¶ÁêÜÔºàË§áÊï∞„Ç≥„Éû„É≥„Éâ„Å´ÂØæÂøúÔºâ
    async function sendCommand(commandString) {
      if (!uartWriteChar) {
        log('Cannot send command: Not connected or write characteristic missing.');
        return false;
      }
      if (!commandString) return false;

      // split by comma, trim
      const parts = String(commandString).split(',').map(p => p.trim()).filter(p => p.length > 0);
      for (const part of parts) {
        const ua = hexStringToUint8(part);
        if (!ua) {
          log(`Skipping invalid command: ${part}`);
          continue;
        }
        try {
          // „É≠„Ç∞Ââç„Å´Ë°®Á§∫„Åó„Å¶„Åä„ÅèÔºàÊàêÂäü„Åó„Åü„Åã„Å©„ÅÜ„Åã„ÅØ try/catch „ÅßËøΩ„ÅÜÔºâ
          log(`Sending: ${part}`);
          // writeValue „ÅØ ArrayBuffer „ÇíÂèó„ÅëÂèñ„Çã (Uint8Array.buffer „ÇíÊ∏°„Åô„Åì„Å®„ÅßÁ¢∫ÂÆü„Å´ ArrayBuffer „ÇíÈÄÅ„Çã)
          await uartWriteChar.writeValue(ua.buffer);
          log(`Write OK: ${part}`);
          // Â∞ë„ÅóÈñìÈöî„ÇíÁΩÆ„ÅèÔºàË§áÊï∞„Ç≥„Éû„É≥„ÉâÊôÇ„Å´„Éá„Éê„Ç§„ÇπÂÅ¥„ÅåÂá¶ÁêÜ„Åô„ÇãÁå∂‰∫à„Çí‰∏é„Åà„ÇãÔºâ
          await new Promise(res => setTimeout(res, 50));
        } catch (err) {
          log(`Write Error for ${part}: ${err}`);
          console.error(err);
          // „Åì„Åì„ÅßÁ∂öË°å„Åô„Çã„Åã‰∏≠Êñ≠„Åô„Çã„Åã„ÇíÂà§Êñ≠„Åß„Åç„Åæ„Åô„ÄÇ‰ªäÂõû„ÅØÊ¨°„ÅÆ„Ç≥„Éû„É≥„Éâ„Å∏ÈÄ≤„Åæ„Åö false „ÇíËøî„Åô„ÄÇ
          return false;
        }
      }
      return true;
    }

    // ------------ Button press logicÔºàÈï∑Êäº„Åó / „Çø„ÉÉ„Éó / „É™„É™„Éº„ÇπÔºâ------------
    function startPress(button) {
      if (!button) return;
      cancelAllPressTimers();
      activeButton = button;
      isLongPress = false;

      pressTimer = setTimeout(async () => {
        isLongPress = true;
        log(`Long press start: ${button.id}`);
        const holdCmd = button.dataset.holdCommand;
        if (holdCmd) {
          // „Åæ„Åö‰∏ÄÂ∫¶ÈÄÅ„Çã
          await sendCommand(holdCmd);
          // Áπ∞„ÇäËøî„ÅóÈÄÅ„ÇãÂ†¥Âêà„ÅØ interval „ÇíÂõû„Åô
          if (button.dataset.repeatable === 'true') {
            repeatIntervalTimer = setInterval(() => {
              // „Éé„É≥„Éñ„É≠„ÉÉ„Ç≠„É≥„Ç∞„ÅßÈÄÅ„ÇãÔºàÂ§±Êïó„ÅØ„É≠„Ç∞Ôºâ
              sendCommand(holdCmd).catch(e => log(`Repeat send error: ${e}`));
            }, REPEAT_INTERVAL);
          }
        } else {
          // hold„Ç≥„Éû„É≥„Éâ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ‰ª£„Çè„Çä„Å´Áü≠Êäº„Åó„Ç≥„Éû„É≥„Éâ„Çí‰Ωø„ÅÜ„Åì„Å®„ÇÇ„ÅÇ„Çã„Åå‰ªäÂõû„ÅØÈÄÅ„Çâ„Å™„ÅÑ
          log(`No holdCommand for ${button.id}`);
        }
      }, LONG_PRESS_DURATION);
    }

    async function endPress() {
      if (!activeButton) return;
      // clear timers first to stop repeats
      cancelAllPressTimers();

      if (isLongPress) {
        // Èï∑Êäº„Åó„ÅÆÂÆå‰∫Ü ‚Üí releaseCommand „Åå„ÅÇ„Çå„Å∞ÈÄÅ„Çã
        const releaseCmd = activeButton.dataset.releaseCommand;
        if (releaseCmd) {
          log(`Sending release for ${activeButton.id}`);
          await sendCommand(releaseCmd);
        } else {
          log(`Long press ended: ${activeButton.id} (no release command)`);
        }
      } else {
        // Áü≠Êäº„ÅóÔºàtapÔºâ
        const tapCmd = activeButton.dataset.command;
        if (tapCmd) {
          log(`Tap detected: ${activeButton.id}`);
          await sendCommand(tapCmd);
        } else {
          log(`Tap on ${activeButton.id} but no command defined`);
        }
      }
      isLongPress = false;
      activeButton = null;
    }

    function cancelAllPressTimers() {
      if (pressTimer) clearTimeout(pressTimer);
      if (repeatIntervalTimer) clearInterval(repeatIntervalTimer);
      pressTimer = null;
      repeatIntervalTimer = null;
    }

    // pointer events „Çí‰Ωø„Å£„Å¶ mouse/touch „Çí‰∏ÄÊú¨ÂåñÔºà„Çà„ÇäÂÆâÂÆöÔºâ
    mainControls.addEventListener('pointerdown', (evt) => {
      const btn = evt.target.closest('button[data-command], button[data-hold-command]');
      if (!btn) return;
      evt.preventDefault();
      startPress(btn);
    });

    // pointerup / pointercancel „ÅßÁµÇ‰∫Ü
    document.addEventListener('pointerup', (evt) => {
      // pointerup „ÅåÊù•„Åü„ÇâÂøÖ„Åö endPress „ÇíÂëº„Å∂
      endPress();
    });
    document.addEventListener('pointercancel', (evt) => {
      endPress();
    });

    // „Éû„Ç¶„Çπ„ÅåÈ†òÂüüÂ§ñ„Å´Âá∫„Åü„ÇâÂº∑Âà∂ÁµÇ‰∫ÜÔºàÂÆâÂÖ®ÂÅ¥Ôºâ
    mainControls.addEventListener('mouseleave', (evt) => {
      if (activeButton) endPress();
    });

    // Clear log
    clearLogButton.addEventListener('click', () => { logArea.value = ''; });

    // UI Êõ¥Êñ∞
    function updateUIForConnection() {
      statusSpan.textContent = 'CONNECTED';
      statusSpan.style.backgroundColor = '#28a745';
      connectButton.disabled = true;
      disconnectButton.disabled = false;
      mainControls.style.display = 'block';
    }
    function updateUIForDisconnection() {
      statusSpan.textContent = 'DISCONNECTED';
      statusSpan.style.backgroundColor = '#dc3545';
      connectButton.disabled = false;
      disconnectButton.disabled = true;
      mainControls.style.display = 'none';
    }

    // „É≠„Ç∞Èñ¢Êï∞
    function log(msg) {
      const ts = new Date().toLocaleTimeString();
      logArea.value += `[${ts}] ${msg}\n`;
      logArea.scrollTop = logArea.scrollHeight;
      console.log(msg);
    }
  </script>
</body>
</html>
