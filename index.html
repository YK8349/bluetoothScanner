<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Power Vision S1 Web Controller ‚Äî Fixed</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ÔºàÁúÅÁï•„Åõ„Åö„Åù„ÅÆ„Åæ„Åæ‰Ωø„Åà„Çã„Çà„ÅÜ„Å´ÂÖÉ„ÅÆ„Çπ„Çø„Ç§„É´„Çí‰øùÊåÅÔºâ */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f0f2f5; }
    .container { display: flex; flex-direction: column; gap: 20px; }
    .control-group { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h1, h2 { text-align: center; color: #333; }
    button { padding: 12px 18px; font-size: 16px; cursor: pointer; border-radius: 6px; border: 1px solid transparent; transition: all 0.2s ease; }
    button:disabled { cursor: not-allowed; opacity: 0.5; }
    #connection-status { font-weight: bold; padding: 5px 10px; border-radius: 5px; color: #fff; }
    #log-area { width: 100%; height: 150px; border: 1px solid #ccc; border-radius: 3px; padding: 5px; box-sizing: border-box; white-space: pre-wrap; overflow-y: scroll; background-color: #fafafa; }
    #connect-button { background-color: #007bff; color: white; border-color: #007bff; }
    #connect-button:hover:not(:disabled) { background-color: #0056b3; }
    #disconnect-button { background-color: #dc3545; color: white; border-color: #dc3545; }
    #disconnect-button:hover:not(:disabled) { background-color: #c82333; }
    .controls-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; justify-items: center; }
    .d-pad { grid-column: 1 / 2; display: grid; grid-template-areas: ". up ." "left center right" ". down ."; width: 150px; height: 150px; }
    .d-pad button { width: 50px; height: 50px; padding: 0; display: flex; justify-content: center; align-items: center; font-size: 24px; background-color: #5a6268; color: white; }
    .d-pad button:hover:not(:disabled) { background-color: #4a5056; }
    #up-button { grid-area: up; }
    #left-button { grid-area: left; }
    #right-button { grid-area: right; }
    #down-button { grid-area: down; }
    .action-buttons { grid-column: 2 / 3; display: flex; flex-direction: column; gap: 15px; justify-content: center; }
    .zoom-buttons { grid-column: 3 / 4; display: flex; flex-direction: column; gap: 15px; justify-content: center; }
    .action-buttons button, .zoom-buttons button { width: 150px; background-color: #28a745; color: white; }
    .action-buttons button:hover:not(:disabled), .zoom-buttons button:hover:not(:disabled) { background-color: #218838; }
    #power-button { background-color: #ffc107; color: #212529; }
    #power-button:hover:not(:disabled) { background-color: #e0a800; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Power Vision S1 Web Controller</h1>

    <div class="control-group">
      <h2><span style="font-size: 1.2em;">üì°</span> Connection</h2>
      <button id="connect-button">Connect to S1 Device</button>
      <button id="disconnect-button" disabled>Disconnect</button>
      <p>Status: <span id="connection-status" style="background-color: red;">DISCONNECTED</span></p>
    </div>

    <div class="control-group" id="main-controls" style="display: none;">
      <h2><span style="font-size: 1.2em;">üïπÔ∏è</span> Controls</h2>
      <div class="controls-grid">
        <div class="d-pad">
          <button id="up-button" data-command="ea550d0a135c2301000000d85e" data-hold-command="ea550d0a135c2303000000b0b3" data-repeatable="true">‚ñ≤</button>
          <button id="left-button" data-command="ea550d0a135c2310000000cb33" data-hold-command="ea550d0a135c23300000008504" data-repeatable="true">‚óÄ</button>
          <button id="center-button" data-command="ea550d0a135c23000010001f2b" data-hold-command="ea550d0a135c230000f000ad3b" data-repeatable="true" style="grid-area: center;">Push</button>
          <button id="right-button" data-command="ea550d0a135c2340000000f046" data-hold-command="ea550d0a135c23c0000000c89b" data-repeatable="true">‚ñ∂</button>
          <button id="down-button" data-command="ea550d0a135c23040000009de2" data-hold-command="ea550d0a135c230c0000005e67" data-repeatable="true">‚ñº</button>
        </div>

        <div class="action-buttons">
          <button id="record-button" data-command="ea550d0a135c23001000000f6b" data-hold-command="ea550d0a135c2300f000003ecb" data-release-command="ea550d0a135c2300e000005d88">Record</button>
          <button id="orientation-button" data-command="ea550d0a135c23000002000e4e">Toggle Orientation</button>
          <button id="reset-button" data-command="ea550d0a135c23000020008a2e,ea550d0a139c0c804c060162f4">Reset Position</button>
          <button id="power-button" data-command="ea550d0a135c23000001005d1b">Power</button>
        </div>

        <div class="zoom-buttons">
          <button id="zoom-in-button" data-command="ea550d0a135c2300040000acf4" data-hold-command="ea550d0a135c23000c00000d5d" data-release-command="ea550d0a135c2300080000cd81" data-repeatable="true">Zoom In (+)</button>
          <button id="zoom-out-button" data-command="ea550d0a135c23000100005c1f" data-hold-command="ea550d0a135c23000300003c71" data-release-command="ea550d0a135c23000200000c46" data-repeatable="true">Zoom Out (-)</button>
        </div>
      </div>
    </div>

    <div class="control-group">
      <h2><span style="font-size: 1.2em;">üìã</span> Log</h2>
      <textarea id="log-area" readonly></textarea>
      <button id="clear-log-button" style="margin-top: 10px;">Clear Log</button>
    </div>
  </div>

<script>
    // --- Constants from analysis ---
    const NORDIC_UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const NORDIC_UART_RX_CHARACTERISTIC_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
    const NORDIC_UART_TX_CHARACTERISTIC_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

    // Command IDs
    const BLE_SET_INFORM_ID = 10;
    const BLE_PTZ_EXPECTED_POSTURE_ID = 12;
    const BLE_APP_PAN_HEARTBEAT_ID = 16;

    // Header fields
    const BLE_START_1 = 0xEA;
    const BLE_START_2 = 0x55;
    const OPERATION_TYPE = 1;
    const SET_FEEDBACK_STATE = 3;
    const INFORM_SEND_ID = 7;
    const INFORM_RECEIVE_ID = 1;

    const SPEED = 1000; // Movement speed
    const HEARTBEAT_INTERVAL = 5000; // 5 seconds

    // --- UI Elements ---
    const connectButton = document.getElementById('connect-button');
    const disconnectButton = document.getElementById('disconnect-button');
    const statusSpan = document.getElementById('connection-status');
    const logArea = document.getElementById('log-area');
    const clearLogButton = document.getElementById('clear-log-button');
    const mainControls = document.getElementById('main-controls');

    // --- BLE State ---
    let bluetoothDevice = null;
    let uartWriteChar = null;
    let expected_posture_value_counter = 0;
    let heartbeatTimer = null;

    // --- Long Press State ---
    let pressTimer = null;
    let repeatIntervalTimer = null;
    let activeDirection = null; // 'up', 'down', 'left', 'right'
    const LONG_PRESS_DURATION = 250; // ms
    const REPEAT_INTERVAL = 150; // ms

    // --- CRC-16/CCITT-FALSE Calculation ---
    function crc16_ccitt_false(data) {
        let crc = 0xFFFF;
        const polynomial = 0x1021;
        for (const byte of data) {
            crc ^= byte << 8;
            for (let i = 0; i < 8; i++) {
                if (crc & 0x8000) {
                    crc = (crc << 1) ^ polynomial;
                } else {
                    crc <<= 1;
                }
            }
        }
        return crc & 0xFFFF;
    }

    // --- Command Building ---
    function buildCommand(commandId, payload) {
        const length = payload.byteLength + 8;
        const header = new ArrayBuffer(6);
        const headerView = new DataView(header);
        headerView.setUint8(0, BLE_START_1);
        headerView.setUint8(1, BLE_START_2);
        headerView.setUint8(2, length);
        headerView.setUint8(3, commandId);
        const packedInfo = (OPERATION_TYPE << 0) | (SET_FEEDBACK_STATE << 4) | (INFORM_SEND_ID << 10) | (INFORM_RECEIVE_ID << 14);
        headerView.setUint16(4, packedInfo, true);
        const message = new Uint8Array(header.byteLength + payload.byteLength);
        message.set(new Uint8Array(header), 0);
        message.set(new Uint8Array(payload), header.byteLength);
        const crcValue = crc16_ccitt_false(message);
        const crcBytes = new ArrayBuffer(2);
        new DataView(crcBytes).setUint16(0, crcValue, true);
        const finalCommand = new Uint8Array(message.byteLength + crcBytes.byteLength);
        finalCommand.set(message, 0);
        finalCommand.set(new Uint8Array(crcBytes), message.byteLength);
        return finalCommand;
    }

    function buildPanExpectedPostureCommand(panSpeed, tiltSpeed, rollSpeed) {
        const commandId = BLE_PTZ_EXPECTED_POSTURE_ID;
        const payload = new ArrayBuffer(16);
        const view = new DataView(payload);
        view.setUint8(0, expected_posture_value_counter);
        expected_posture_value_counter = (expected_posture_value_counter + 1) % 256;
        const packedFlags = (0 << 0) | (0 << 1) | (1 << 2) | (1 << 3) | (1 << 4) | (1 << 5);
        view.setUint8(1, packedFlags);
        view.setInt16(2, 0, true);
        view.setInt16(4, 0, true);
        view.setInt16(6, 0, true);
        view.setInt16(8, rollSpeed, true);
        view.setInt16(10, tiltSpeed, true);
        view.setInt16(12, panSpeed, true);
        view.setInt16(14, 0, true);
        return buildCommand(commandId, payload);
    }
    
    function buildSetGimbalModeCommand(mode) {
        const commandId = BLE_SET_INFORM_ID;
        const addressType = 12; // PV_GIM_PARM_SET
        const payload = new ArrayBuffer(5);
        const view = new DataView(payload);
        view.setUint8(0, addressType);
        view.setUint32(1, mode, true); // mode 0 = Follow Mode
        return buildCommand(commandId, payload);
    }

    function buildAppToPanCommand() {
        const commandId = BLE_APP_PAN_HEARTBEAT_ID;
        const payload = new ArrayBuffer(12);
        const view = new DataView(payload);
        view.setUint32(0, Date.now(), true); // systemTime
        view.setUint16(4, 0, true); // packedFlags
        view.setUint16(6, 0, true); // packedMode
        view.setUint32(8, 0, true); // reserved
        return buildCommand(commandId, payload);
    }

    // --- BLE Send/Receive ---
    async function sendCommand(commandBytes, logIt = false) {
        if (!uartWriteChar) {
            log('Cannot send command: Not connected.');
            return;
        }
        try {
            await uartWriteChar.writeValueWithoutResponse(commandBytes);
            if(logIt) log(`Sent: ${Array.from(commandBytes).map(b => b.toString(16).padStart(2, '0')).join('')}`);
        } catch (err) {
            log(`Write Error: ${err}`);
        }
    }

    function handleNotifications(event) {
        const value = event.target.value;
        let hex = '';
        for (let i = 0; i < value.byteLength; i++) {
            hex += value.getUint8(i).toString(16).padStart(2, '0');
        }
        log(`Received: ${hex}`);
    }

    // --- Connection Logic ---
    connectButton.addEventListener('click', async () => {
        log('Requesting device...');
        try {
            bluetoothDevice = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'S1' }],
                optionalServices: [NORDIC_UART_SERVICE_UUID]
            });

            bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
            log('Connecting to GATT server...');
            const server = await bluetoothDevice.gatt.connect();

            log('Getting UART service...');
            const service = await server.getPrimaryService(NORDIC_UART_SERVICE_UUID);

            log('Getting characteristics...');
            uartWriteChar = await service.getCharacteristic(NORDIC_UART_RX_CHARACTERISTIC_UUID);
            const uartNotifyChar = await service.getCharacteristic(NORDIC_UART_TX_CHARACTERISTIC_UUID);

            log('Starting notifications...');
            await uartNotifyChar.startNotifications();
            uartNotifyChar.addEventListener('characteristicvaluechanged', handleNotifications);
            
            updateUIForConnection();
            log('Device configured. Ready for control.');

            // *** FIX: Set gimbal mode to Follow (0) to prevent returning to center ***
            log('Setting gimbal to Follow Mode...');
            await sendCommand(buildSetGimbalModeCommand(0), true);

            // *** FIX: Start heartbeat to prevent disconnection ***
            log('Starting heartbeat...');
            heartbeatTimer = setInterval(() => {
                // log('Sending heartbeat...');
                sendCommand(buildAppToPanCommand());
            }, HEARTBEAT_INTERVAL);

        } catch (err) {
            log(`Connection Error: ${err}`);
            if (bluetoothDevice && bluetoothDevice.gatt.connected) bluetoothDevice.gatt.disconnect();
        }
    });

    disconnectButton.addEventListener('click', () => {
        if (bluetoothDevice && bluetoothDevice.gatt.connected) {
            log('Disconnecting...');
            bluetoothDevice.gatt.disconnect();
        }
    });

    function onDisconnected() {
        log('Device disconnected.');
        if (heartbeatTimer) clearInterval(heartbeatTimer);
        heartbeatTimer = null;
        updateUIForDisconnection();
        uartWriteChar = null;
        bluetoothDevice = null;
        activeDirection = null;
        cancelAllPressTimers();
    }

    // --- Button Press Logic (Long Press / Tap) ---
    function startPress(direction) {
        if (!direction || activeDirection) return;
        cancelAllPressTimers();
        activeDirection = direction;
        sendMovementCommand(direction);
        pressTimer = setTimeout(() => {
            log(`Long press start: ${direction}`);
            repeatIntervalTimer = setInterval(() => {
                sendMovementCommand(direction);
            }, REPEAT_INTERVAL);
        }, LONG_PRESS_DURATION);
    }

    function endPress() {
        if (!activeDirection) return;
        cancelAllPressTimers();
        log(`Press ended: ${activeDirection}`);
        activeDirection = null;
        const stopCommand = buildPanExpectedPostureCommand(0, 0, 0);
        sendCommand(stopCommand);
    }
    
    function sendMovementCommand(direction) {
        let pan = 0, tilt = 0;
        switch (direction) {
            case 'up':    tilt = SPEED;  break;
            case 'down':  tilt = -SPEED; break;
            case 'left':  pan = -SPEED;  break;
            case 'right': pan = SPEED;   break;
        }
        const command = buildPanExpectedPostureCommand(pan, tilt, 0);
        sendCommand(command);
    }

    function cancelAllPressTimers() {
        clearTimeout(pressTimer);
        clearInterval(repeatIntervalTimer);
        pressTimer = null;
        repeatIntervalTimer = null;
    }

    // --- Event Listeners ---
    document.getElementById('up-button').addEventListener('pointerdown', () => startPress('up'));
    document.getElementById('down-button').addEventListener('pointerdown', () => startPress('down'));
    document.getElementById('left-button').addEventListener('pointerdown', () => startPress('left'));
    document.getElementById('right-button').addEventListener('pointerdown', () => startPress('right'));
    document.addEventListener('pointerup', endPress);
    document.addEventListener('pointercancel', endPress);
    mainControls.addEventListener('pointerleave', endPress);

    // Other buttons are not implemented based on the analyzed code
    document.getElementById('center-button').addEventListener('click', () => log("Center command not implemented."));
    document.getElementById('record-button').addEventListener('click', () => log("Record command not implemented."));
    document.getElementById('orientation-button').addEventListener('click', () => log("Orientation command not implemented."));
    document.getElementById('reset-button').addEventListener('click', () => log("Reset command not implemented."));
    document.getElementById('power-button').addEventListener('click', () => log("Power command not implemented."));
    document.getElementById('zoom-in-button').addEventListener('click', () => log("Zoom In command not implemented."));
    document.getElementById('zoom-out-button').addEventListener('click', () => log("Zoom Out command not implemented."));

    // --- UI & Logging ---
    clearLogButton.addEventListener('click', () => { logArea.value = ''; });

    function updateUIForConnection() {
        statusSpan.textContent = 'CONNECTED';
        statusSpan.style.backgroundColor = '#28a745';
        connectButton.disabled = true;
        disconnectButton.disabled = false;
        mainControls.style.display = 'block';
    }

    function updateUIForDisconnection() {
        statusSpan.textContent = 'DISCONNECTED';
        statusSpan.style.backgroundColor = '#dc3545';
        connectButton.disabled = false;
        disconnectButton.disabled = true;
        mainControls.style.display = 'none';
    }

    function log(msg) {
        const ts = new Date().toLocaleTimeString();
        logArea.value += `[${ts}] ${msg}
`;
        logArea.scrollTop = logArea.scrollHeight;
        console.log(msg);
    }
  </script>
</body>
</html>
